dat_procedures_temp<-merge(dat_procedures_temp,dat_codebook_temp,by.x="Patient.Id",by.y="Patient.id",all.x=T,all.y=T)
dat_procedures_temp<-dat_procedures_temp[,colnames(dat_procedures_temp)[colnames(dat_procedures_temp)!="Patient.Id"]]
dat_covid_procedures<-rbind(dat_covid_procedures,dat_procedures_temp)
print("Procedures")
print(nrow(dat_covid_procedures))
###Import Orders/Order Sets: not used it this time
dat_orders_temp<-read.csv(file.path(data_dir,folder_name,"orders_and_ordesets.csv"),stringsAsFactors = F)
dat_orders_temp<-merge(dat_orders_temp,dat_codebook_temp,by.x="Patient.Id",by.y="Patient.id",all.x=T,all.y=T)
dat_orders_temp<-dat_orders_temp[,colnames(dat_orders_temp)[colnames(dat_orders_temp)!="Patient.Id"]]
#
dat_covid_orders<-rbind(dat_covid_orders,dat_orders_temp)
print("Order Sets")
print(nrow(dat_covid_orders))
###Import Diagnoses
dat_dx_temp<-read.csv(file.path(data_dir,folder_name,"diagnoses.csv"),stringsAsFactors = F)
dat_dx_temp<-merge(dat_dx_temp,dat_codebook_temp,by.x="Patient.Id",by.y="Patient.id",all.x=T,all.y=T)
dat_dx_temp<-dat_dx_temp[,colnames(dat_dx_temp)[colnames(dat_dx_temp)!="Patient.Id"]]
dat_covid_dx<-rbind(dat_covid_dx,dat_dx_temp)
print("Diagnoses")
print(nrow(dat_covid_dx))
}
data_dir
folder_name
dat_orders_temp<-read.csv(file.path(data_dir,folder_name,"orders_and_ordesets.csv"),stringsAsFactors = F)
dat_orders_temp<-merge(dat_orders_temp,dat_codebook_temp,by.x="Patient.Id",by.y="Patient.id",all.x=T,all.y=T)
dat_orders_temp<-dat_orders_temp[,colnames(dat_orders_temp)[colnames(dat_orders_temp)!="Patient.Id"]]
#
dat_covid_orders<-rbind(dat_covid_orders,dat_orders_temp)
print("Order Sets")
print(nrow(dat_covid_orders))
dat_orders_temp<-read.csv(file.path(data_dir,folder_name,"orders_and_ordesets.csv"),stringsAsFactors = F)
dat_orders_temp<-read.csv(file.path(data_dir,folder_name,"orders_and_ordersets.csv"),stringsAsFactors = F)
###import combined all the data
dat_covid_demo<-data.frame()
dat_covid_encounters<-data.frame()
dat_covid_lab<-data.frame()
dat_covid_adt<-data.frame()
dat_covid_procedures<-data.frame()
dat_covid_orders<-data.frame()
dat_covid_dx<-data.frame()
for (i in 1:length(data_folder_format)){
folder_name<-data_folder_format[i]
print(folder_name)
###import code book
print("Code Book")
dat_codebook_temp<-read.csv(file.path(data_dir,folder_name,"patientCodebook.csv"),stringsAsFactors = F)
print(nrow(dat_codebook_temp))
##import demographics
dat_demo_temp<-read.csv(file.path(data_dir,folder_name,"demographics.csv"),stringsAsFactors = F)
dat_demo_temp<-merge(dat_demo_temp,dat_codebook_temp,by.x="Patient.Id",by.y="Patient.id",all.x=T,all.y=T)
dat_demo_temp<-dat_demo_temp[,colnames(dat_demo_temp)[colnames(dat_demo_temp)!="Patient.Id"]]
dat_covid_demo<-unique(rbind(dat_covid_demo,dat_demo_temp))
print("Demographics")
print(nrow(dat_covid_demo))
###import encounter
dat_encounters_temp<-read.csv(file.path(data_dir,folder_name,"encounters.csv"),stringsAsFactors = F)
dat_encounters_temp<-merge(dat_encounters_temp,dat_codebook_temp,by.x="Patient.Id",by.y="Patient.id",all.x=T,all.y=T)
dat_encounters_temp<-dat_encounters_temp[,colnames(dat_encounters_temp)[colnames(dat_encounters_temp)!="Patient.Id"]]
dat_covid_encounters<-rbind(dat_covid_encounters,dat_encounters_temp)
print("Encounters")
print(nrow(dat_covid_encounters))
###Import Labs
dat_labs_temp<-read.csv(file.path(data_dir,folder_name,"labs.csv"),stringsAsFactors = F)
dat_labs_temp<-merge(dat_labs_temp,dat_codebook_temp,by.x="Patient.Id",by.y="Patient.id",all.x=T,all.y=T)
dat_labs_temp<-dat_labs_temp[,colnames(dat_labs_temp)[colnames(dat_labs_temp)!="Patient.Id"]]
dat_covid_lab<-rbind(dat_covid_lab,dat_labs_temp)
print("Labs")
print(nrow(dat_covid_lab))
###Import ADT
dat_adt_temp<-read.csv(file.path(data_dir,folder_name,"adt.csv"),stringsAsFactors = F)
dat_adt_temp<-merge(dat_adt_temp,dat_codebook_temp,by.x="Patient.Id",by.y="Patient.id",all.x=T,all.y=T)
dat_adt_temp<-dat_adt_temp[,colnames(dat_adt_temp)[colnames(dat_adt_temp)!="Patient.Id"]]
dat_covid_adt<-rbind(dat_covid_adt,dat_adt_temp)
print("ADT")
print(nrow(dat_covid_adt))
###Import Procedures
dat_procedures_temp<-read.csv(file.path(data_dir,folder_name,"procedures.csv"),stringsAsFactors = F)
dat_procedures_temp<-merge(dat_procedures_temp,dat_codebook_temp,by.x="Patient.Id",by.y="Patient.id",all.x=T,all.y=T)
dat_procedures_temp<-dat_procedures_temp[,colnames(dat_procedures_temp)[colnames(dat_procedures_temp)!="Patient.Id"]]
dat_covid_procedures<-rbind(dat_covid_procedures,dat_procedures_temp)
print("Procedures")
print(nrow(dat_covid_procedures))
###Import Orders/Order Sets: not used it this time
dat_orders_temp<-read.csv(file.path(data_dir,folder_name,"orders_and_ordersets.csv"),stringsAsFactors = F)
dat_orders_temp<-merge(dat_orders_temp,dat_codebook_temp,by.x="Patient.Id",by.y="Patient.id",all.x=T,all.y=T)
dat_orders_temp<-dat_orders_temp[,colnames(dat_orders_temp)[colnames(dat_orders_temp)!="Patient.Id"]]
#
dat_covid_orders<-rbind(dat_covid_orders,dat_orders_temp)
print("Order Sets")
print(nrow(dat_covid_orders))
###Import Diagnoses
dat_dx_temp<-read.csv(file.path(data_dir,folder_name,"diagnoses.csv"),stringsAsFactors = F)
dat_dx_temp<-merge(dat_dx_temp,dat_codebook_temp,by.x="Patient.Id",by.y="Patient.id",all.x=T,all.y=T)
dat_dx_temp<-dat_dx_temp[,colnames(dat_dx_temp)[colnames(dat_dx_temp)!="Patient.Id"]]
dat_covid_dx<-rbind(dat_covid_dx,dat_dx_temp)
print("Diagnoses")
print(nrow(dat_covid_dx))
}
library(data.table)
dat_covid_demo<-data.frame(unique(data.table(dat_covid_demo)))
dat_covid_encounters<-data.frame(unique(data.table(dat_covid_encounters)))
dat_covid_lab<-data.frame(unique(data.table(dat_covid_lab)))
dat_covid_adt<-data.frame(unique(data.table(dat_covid_adt)))
dat_covid_procedures<-data.frame(unique(data.table(dat_covid_procedures)))
dat_covid_orders<-data.frame(unique(data.table(dat_covid_orders)))
dat_covid_dx<-data.frame(unique(data.table(dat_covid_dx)))
nrow(dat_covid_demo)
##3193
nrow(dat_covid_encounters)
###498442
nrow(dat_covid_lab)
#2149625
nrow(dat_covid_adt)
#38678
nrow(dat_covid_procedures)
#294422
nrow(dat_covid_orders)
#
nrow(dat_covid_dx)
#729697
###Build the Hospitalized Cohort
##clean the lab data
dat_covid_lab$Authorizing.Provider.Name<-sapply(strsplit(dat_covid_lab$Authorizing.Provider, " - "), "[", 1)
dat_covid_lab$Authorizing.Provider.Dept<-sapply(strsplit(dat_covid_lab$Authorizing.Provider, " - "), "[", 2)
dat_covid_lab$Result.Dt<-as.Date(substring(dat_covid_lab$Result.Date,1,10),"%m/%d/%Y")
dat_covid_lab$Result.Date<-as_datetime(dat_covid_lab$Result.Date,"%m/%d/%Y %H:%M",tz="US/Pacific")
dat_covid_lab$Taken.Date<-as_datetime(dat_covid_lab$Taken.Date,"%m/%d/%Y %H:%M",tz="US/Pacific")
dat_covid_lab$Order.Date<-as_datetime(dat_covid_lab$Order.Date,"%m/%d/%Y %H:%M",tz="US/Pacific")
dat_covid_lab<-dat_covid_lab[order(dat_covid_lab$MRN,dat_covid_lab$Order.Date),]
covid_test_names<-unique(dat_covid_lab$Lab)[grepl("covid",tolower(unique(dat_covid_lab$Lab)),fixed=T)|grepl("sars",tolower(unique(dat_covid_lab$Lab)),fixed=T)|grepl("coronavirus",tolower(unique(dat_covid_lab$Lab)),fixed=T)]
covid_test_names<-covid_test_names[covid_test_names %in% c(
"SARS-CoV-2, IgG & IgM",
"SARS-COV-2 Antibody, IgG & IgM" ,
"COVID ED BIOREPOSITORY (STUDY)- PAXgene",
"COVID ED BIOREPOSITORY (STUDY)- HEPARIN",
"COVID ED BIOREPOSITORY (STUDY)- EDTA",
"SARS Conornavirus, QL Manual Entry",
"COVID ED BIOREPOSITORY (STUDY)- SWAB",
"COVID ED BIOREPOSITORY (STUDY)- EDTA 6.0" ,
"COVID ED BIOREPOSITORY (STUDY)- CPT",
"COVID ED BIOREPOSITORY (STUDY)- SST",
"SARS CoV 2 Serology (Covid 19) Ab (IgG), IA",
"SARS-COV-2 AB, IGG",
"SARS-COV-2 AB, IGM",
"DIASORIN SARS-COV-2 AB, IGG",
"SARS-CoV-2 Ab, IgM",
###Updated as if 9/16/2020
"SARS-CoV-2 Antibody, IgG",
"SARS-CoV-2 Antibody, IgM")==F]
covid_test_names<-covid_test_names[grep("IgG",covid_test_names,fixed=T)==F &grep("IgM",covid_test_names,fixed=T)==F]
###updated as if 9/29 to include more RT-PCR results
result_names<-unique(dat_covid_lab$Result[grepl("sars",tolower(dat_covid_lab$Result),fixed=T)])
result_names<-result_names[grepl("igg",tolower(result_names),fixed=T)==F &grepl("igm",tolower(result_names),fixed=T)==F & grepl("ace2",tolower(result_names),fixed=T)==F & grepl("abs",tolower(result_names),fixed=T)==F & grepl("antibody",tolower(result_names),fixed=T)==F]
dat_covid_pos<-dat_covid_lab[ dat_covid_lab$Result %in% result_names & tolower(dat_covid_lab$Value) %in% c("detected","yes","pos","positive","present") & grepl("serology",tolower(dat_covid_lab$Lab),fixed=T)==F,] ##updated 12/1: removing serology results
nrow(dat_covid_pos)
unique(dat_covid_pos[,c("Result","Lab")])
unique(dat_covid_pos$Value)
length(unique(dat_covid_pos$MRN))
##order date could be missing
dat_covid_initial<-
dat_covid_pos %>%
arrange(MRN,Taken.Date,.by_group = TRUE) %>%
group_by(MRN) %>%
filter(row_number()==1)
summary(dat_covid_initial$PatEncCsnCoded)
nrow(dat_covid_initial)
dat_covid_initial$PatEncCsnCoded[is.na(dat_covid_initial$PatEncCsnCoded)]<-"999999999999"
colnames(dat_covid_initial)[colnames(dat_covid_initial)=="Age"]<-"Age_Covidpos"
###remove missing MRN for demographics due to DOB
dat_covid_demo[dat_covid_demo$Date.of.Death=="" &is.na(dat_covid_demo$Date.of.Death)==F,"Date.of.Death"]<-NA
dat_covid_demo<-unique(dat_covid_demo[is.na(dat_covid_demo$MRN)==F,])
###Updated: 1/19/2 use the initial
dat_covid_initial<-merge(dat_covid_initial,dat_covid_demo,by="MRN",all.x=T)
###merge with the initial encounter
dat_covid_encounters$Date<-as.Date(substring(dat_covid_encounters$Date,1,10),"%m/%d/%Y")
dat_covid_encounters_within2years<-dat_covid_encounters[dat_covid_encounters$Date>=as.Date("03-01-2018","%m-%d-%Y"),]
dat_covid_encounters_within2years_byid<-unique(dat_covid_encounters_within2years[is.na(dat_covid_encounters_within2years$PatEncCsnCoded)==F,])
dat_covid_encounters_within2years_byid<-dat_covid_encounters_within2years_byid[order(dat_covid_encounters_within2years_byid$PatEncCsnCoded),]
dat_covid_initial<-merge(dat_covid_initial,dat_covid_encounters_within2years_byid,by=c("MRN","PatEncCsnCoded"),all.x=T)
colnames(dat_covid_initial)[colnames(dat_covid_initial)=="Date"]<-"Encounter.Date"
colnames(dat_covid_initial)[colnames(dat_covid_initial)=="Age"]<-"Age_Encounter"
dat_covid_initial<-dat_covid_initial[, colnames(dat_covid_initial)[colnames(dat_covid_initial) %in% "Name.y"==F]]
colnames(dat_covid_initial)[colnames(dat_covid_initial)=="Name.x"]<-"Name"
###Reformat Initial Data
dat_covid_initial$Admission.Time<-as_datetime(dat_covid_initial$Admission.Time,"%m/%d/%Y %H:%M",tz="US/Pacific")
dat_covid_initial$Discharge.Time<-as_datetime(dat_covid_initial$Discharge.Time,"%m/%d/%Y %H:%M",tz="US/Pacific")
nrow(dat_covid_initial[is.na(dat_covid_initial$IPEpisodeCoded)==F,])
dat_covid_initial<-dat_covid_initial[is.na(dat_covid_initial$MRN)==F,]
###Limited to Result date as if before 9/6/2021
data_before_cut<-data_cut_date-1
print(data_before_cut)
dat_covid_initial<-dat_covid_initial[dat_covid_initial$Taken.Date<data_before_cut & is.na(dat_covid_initial$Taken.Date)==F,]
nrow(dat_covid_initial)
summary(dat_covid_initial$Taken.Date)
summary(dat_covid_initial$Result.Date)
###Inpatient data after 3/1/21
dat_covid_inpatient<-dat_covid_encounters[dat_covid_encounters$Patient.Class %in% c("Inpatient","Observation","Surgery Admit") & is.na(dat_covid_encounters$Date)==F&dat_covid_encounters$Date>as.Date("03-01-2021","%m-%d-%Y") & dat_covid_encounters$Date<data_before_cut& is.na(dat_covid_encounters$Admission.Time)==F & dat_covid_encounters$Admission.Time!="",]
dat_covid_inpatient<-dat_covid_inpatient[row.names(dat_covid_inpatient) %in% row.names(dat_covid_inpatient)[duplicated(dat_covid_inpatient[,1:ncol(dat_covid_inpatient)])==F],]
nrow(dat_covid_inpatient)
#473
length(unique(dat_covid_inpatient$MRN))
dat_covid_inpatient_pediatric<-dat_covid_inpatient[(dat_covid_inpatient$Admission.Age<18 & is.na(dat_covid_inpatient$Admission.Age)==F)|(is.na(dat_covid_inpatient$Discharge.Age)==F & dat_covid_inpatient$Discharge.Age<18),]
nrow(dat_covid_inpatient_pediatric)
#97
head(dat_covid_inpatient_pediatric)
###Exlcude LPCH encounters
dat_covid_inpatient<-dat_covid_inpatient[dat_covid_inpatient$Encounter.Type!="LPCH" ,]
nrow(dat_covid_inpatient)
length(unique(dat_covid_inpatient$MRN))
nrow(unique(dat_covid_inpatient[,c("MRN","IPEpisodeCoded")]))
#398 non-LPCH hospitalizations in 287 patients within the 398 unique Ip episodes
dat_covid_inpatient<-dat_covid_inpatient[order(dat_covid_inpatient$MRN,dat_covid_inpatient$IPEpisodeCoded),]
###Episode level
##Only one duplicated Episode
dat_covid_inpatient_duplicated<-dat_covid_inpatient[dat_covid_inpatient$IP.Episode %in% dat_covid_inpatient[duplicated(dat_covid_inpatient$IP.Episode),"IP.Episode"],]
##0 duplicated
dat_covid_inpatient_exclude<-dat_covid_inpatient_duplicated
##0 rows
dat_covid_inpatient<-dat_covid_inpatient
nrow(dat_covid_inpatient)
length(unique(dat_covid_inpatient$MRN))
table(round(dat_covid_inpatient$Age))
dat_covid_inpatient<-merge(dat_covid_inpatient,dat_covid_initial[,c("MRN","Taken.Date" , "Result.Date","Order.Date","PatEncCsnCoded" )],by="MRN",all.x=T)
colnames(dat_covid_inpatient)[colnames(dat_covid_inpatient)=="PatEncCsnCoded.x"]<-"PatEncCsnCoded.inp"
colnames(dat_covid_inpatient)[colnames(dat_covid_inpatient)=="PatEncCsnCoded.y"]<-"PatEncCsnCoded.lab"
dat_covid_inpatient_kids<-dat_covid_inpatient[(dat_covid_inpatient$Admission.Age<18 & is.na(dat_covid_inpatient$Admission.Age)==F)|(is.na(dat_covid_inpatient$Discharge.Age)==F & dat_covid_inpatient$Discharge.Age<18),]
nrow(dat_covid_inpatient_kids)
length(unique(dat_covid_inpatient_kids$MRN))
#34 kids out of 47 encounters excluded
dat_covid_inpatient<-dat_covid_inpatient[dat_covid_inpatient$Admission.Age>=18 &is.na(dat_covid_inpatient$Admission.Age)==F,]
nrow(dat_covid_inpatient)
length(unique(dat_covid_inpatient$MRN))
#351 inpatient encounters in 253 total adult patients
dat_covid_inpatient$Admission.Time<-as_datetime(dat_covid_inpatient$Admission.Time,"%m/%d/%Y %H:%M",tz="US/Pacific")
dat_covid_inpatient$Discharge.Time<-as_datetime(dat_covid_inpatient$Discharge.Time,"%m/%d/%Y %H:%M",tz="US/Pacific")
dat_covid_inpatient$days_take_adm<-as.numeric(difftime(dat_covid_inpatient$Taken.Date,dat_covid_inpatient$Admission.Time,units="days"))
dat_covid_inpatient$days_take_disch<-as.numeric(difftime(dat_covid_inpatient$Taken.Date,dat_covid_inpatient$Discharge.Time,units="days"))
dat_covid_inpatient$days_result_adm<-as.numeric(difftime(dat_covid_inpatient$Result.Date,dat_covid_inpatient$Admission.Time,units="days"))
###Add Diagnosis of Covid
dat_covid_dx_inpatient<-dat_covid_dx[dat_covid_dx$ICD10.Code=="U07.1" & dat_covid_dx$PatEncCsnCoded %in% dat_covid_inpatient$PatEncCsnCoded.inp,]
dat_covid_inpatient$covid_dx<-ifelse(dat_covid_inpatient$PatEncCsnCoded.inp %in% dat_covid_dx_inpatient$PatEncCsnCoded,1,0)
###1. Direct Admission
dat_covid_inpatient_directadm<-dat_covid_inpatient[
###patient with a linked encoutner id
dat_covid_inpatient$PatEncCsnCoded.inp==dat_covid_inpatient$PatEncCsnCoded.lab|
## patients triaged from other outpatient settings whereas their lab tests was taken there
(dat_covid_inpatient$days_take_adm+2>0 & dat_covid_inpatient$days_take_adm<=0 )|
###patients with their intial test happened during stay while not discharged yet
(is.na(dat_covid_inpatient$Discharge.Time) & dat_covid_inpatient$Taken.Date>=dat_covid_inpatient$Admission.Time)|
###patients with their intial test happened during stay and has been already discharged
(is.na(dat_covid_inpatient$Discharge.Time)==F & dat_covid_inpatient$Taken.Date>=dat_covid_inpatient$Admission.Time &dat_covid_inpatient$Taken.Date<=dat_covid_inpatient$Discharge.Time),]
nrow(dat_covid_inpatient_directadm)
length(unique(dat_covid_inpatient_directadm$MRN))
###Remove duplicated results with transfer from one department to the other.
library(tidyverse)
dat_covid_inpatient_directadm<-
dat_covid_inpatient_directadm %>%
group_by(MRN)  %>%
mutate(last_discharge_time=max(Discharge.Time))
dat_covid_inpatient_directadm<-
data.frame(dat_covid_inpatient_directadm)
dat_covid_inpatient_directadm<-dat_covid_inpatient_directadm[(dat_covid_inpatient_directadm$Discharge.Time==dat_covid_inpatient_directadm$last_discharge_time &is.na(dat_covid_inpatient_directadm$Discharge.Time)==F)|is.na(dat_covid_inpatient_directadm$Discharge.Time),]
dat_covid_inpatient_directadm<-dat_covid_inpatient_directadm[is.na(dat_covid_inpatient_directadm$MRN)==F,]
nrow(dat_covid_inpatient_directadm)
###209
View(dat_covid_inpatient_directadm[dat_covid_inpatient_directadm$MRN %in% dat_covid_inpatient_directadm$MRN[duplicated(dat_covid_inpatient_directadm$MRN)],])
###Updated: 9/29: Still duplications, there two inpatient id assigned for each patient-encounter
dat_covid_inpatient_directadm<-dat_covid_inpatient_directadm[,colnames(dat_covid_inpatient_directadm)[colnames(dat_covid_inpatient_directadm) %in% c("HospAccountCoded","IPEpisodeCoded" ,"Description" ,"InpatientDataIdCoded"  )==F]]
dat_covid_inpatient_directadm_csnid<-dat_covid_inpatient_directadm[,c("MRN","PatEncCsnCoded.inp")] %>%
group_by(MRN) %>%
mutate(id = 1:n()) %>%
pivot_wider(
names_from = id,
names_prefix = "PatEncCsnCoded.inp.",
values_from = c(PatEncCsnCoded.inp)
)
dat_covid_inpatient_directadm<-merge(dat_covid_inpatient_directadm,dat_covid_inpatient_directadm_csnid,by="MRN",all.x=T)
dat_covid_inpatient_directadm<-dat_covid_inpatient_directadm[dat_covid_inpatient_directadm$PatEncCsnCoded.inp==dat_covid_inpatient_directadm$PatEncCsnCoded.inp.1,]
###remove duplicates: updated 10/27/2020
dat_covid_inpatient_directadm<-unique(dat_covid_inpatient_directadm)
nrow(dat_covid_inpatient_directadm)
length(unique(dat_covid_inpatient_directadm$MRN))
summary(dat_covid_inpatient_directadm$days_take_adm)
summary(dat_covid_inpatient_directadm$days_take_disch)
summary(dat_covid_inpatient_directadm$Admission.Time)
##Admission time is 7/5-8/31 as similar to the initial test range
summary(dat_covid_inpatient_directadm$Taken.Date)
summary(dat_covid_inpatient_directadm$Result.Date)
###admission till 8/31/2021
###double check whether they had additional tests performed within their admission dates
dat_covid_inpatient_return_all<-dat_covid_inpatient[dat_covid_inpatient$MRN %in% dat_covid_inpatient_directadm$MRN==F ,]
nrow(dat_covid_inpatient_return_all)
#101
length(unique(dat_covid_inpatient_return_all$MRN))
#82
dat_covid_last<-
dat_covid_pos %>%
arrange(MRN,desc(Taken.Date),.by_group = TRUE) %>%
group_by(MRN) %>%
filter(row_number()==1)
summary(dat_covid_last$PatEncCsnCoded)
nrow(dat_covid_last)
dat_covid_last[is.na(dat_covid_last$PatEncCsnCoded),"PatEncCsnCoded"]<-"999999999"
colnames(dat_covid_last)[colnames(dat_covid_last)=="Taken.Date"]<-"Taken.Date.Last"
colnames(dat_covid_last)[colnames(dat_covid_last)=="Result.Date"]<-"Result.Date.Last"
colnames(dat_covid_last)[colnames(dat_covid_last)=="Order.Date"]<-"Order.Date.Last"
dat_covid_pos_return<-merge(dat_covid_pos[,c("MRN","PatEncCsnCoded","Taken.Date","Order.Date","Result.Date")],dat_covid_inpatient_return_all[,c("MRN","PatEncCsnCoded.inp","Admission.Time","Discharge.Time")],by="MRN",all.x=T)
dat_covid_pos_return<-dat_covid_pos_return[is.na(dat_covid_pos_return$PatEncCsnCoded.inp)==F,]
dat_covid_pos_return$days_taken_adm<-as.numeric(difftime(dat_covid_pos_return$Taken.Date,dat_covid_pos_return$Admission.Time,units="days"))
dat_covid_pos_return$days_taken_disch<-as.numeric(difftime(dat_covid_pos_return$Taken.Date,dat_covid_pos_return$Discharge.Time,units="days"))
###add dx codes criteria
dat_covid_pos_return$covid_dx<-ifelse(dat_covid_pos_return$PatEncCsnCoded.inp %in% dat_covid_dx_inpatient$PatEncCsnCoded,1,0)
dat_covid_pos_return<-dat_covid_pos_return[
###patient with a linked encoutner id
(is.na(dat_covid_pos_return$PatEncCsnCoded)==F &dat_covid_pos_return$PatEncCsnCoded.inp==dat_covid_pos_return$PatEncCsnCoded)|
## patients triaged from other outpatient settings whereas their lab tests was taken there
(dat_covid_pos_return$days_taken_adm+2>0 & dat_covid_pos_return$days_taken_adm<=0 )|
###patients with their intial test happened during stay while not discharged yet
(is.na(dat_covid_pos_return$Discharge.Time) & dat_covid_pos_return$Taken.Date>=dat_covid_pos_return$Admission.Time)|
###patients with their intial test happened during stay and has been already discharged
(is.na(dat_covid_pos_return$Discharge.Time)==F & dat_covid_pos_return$Taken.Date>=dat_covid_pos_return$Admission.Time &dat_covid_pos_return$Taken.Date<=dat_covid_pos_return$Discharge.Time)|
###8/17: add dx codes criteria
(dat_covid_pos_return$covid_dx==1),]
###Use the initial test as the return test
dat_covid_return_initial<-
dat_covid_pos_return %>%
arrange(MRN,Taken.Date,.by_group = TRUE) %>%
group_by(MRN) %>%
filter(row_number()==1)
nrow(dat_covid_return_initial)
colnames(dat_covid_return_initial)[c(3:5,9:10)]<-c("Return.Taken.Date","Return.Order.Date","Return.Result.Date","days_return_taken_adm","days_return_taken_disch")
summary(dat_covid_return_initial$days_return_taken_adm)
summary(dat_covid_return_initial$days_return_taken_disch)
###Construct the return cohort
dat_covid_inpatient<-merge(dat_covid_inpatient,dat_covid_last[,c("MRN","Order.Date.Last","Taken.Date.Last","Result.Date.Last")],by="MRN",all.x=T)
dat_covid_inpatient$days_result_adm_last<-as.numeric(difftime(dat_covid_inpatient$Result.Date.Last,dat_covid_inpatient$Admission.Time,units="days"))
###modified as if 7/29: Consider update the definition in next week grandrounds presentation
dat_covid_inpatient_return<-dat_covid_inpatient[
dat_covid_inpatient$MRN %in% dat_covid_inpatient_directadm$MRN==F &
(((abs(dat_covid_inpatient$days_result_adm_last)<15|abs(dat_covid_inpatient$days_result_adm)<15)& (is.na(dat_covid_inpatient$days_take_disch)|(is.na(dat_covid_inpatient$days_take_disch)==F & dat_covid_inpatient$days_take_disch<=0)))|
(dat_covid_inpatient$covid_dx==1)),]
nrow(dat_covid_inpatient_return)
##65
length(unique(dat_covid_inpatient_return$MRN))
dat_covid_inpatient_return<-unique(dat_covid_inpatient_return[,colnames(dat_covid_inpatient_return)[colnames(dat_covid_inpatient_return) %in% c(  "HospAccountCoded" ,"IPEpisodeCoded" , "Description", "InpatientDataIdCoded"  )==F]])
dat_covid_inpatient_return<-dat_covid_inpatient_return[dat_covid_inpatient_return$PatEncCsnCoded.inp %in% dat_covid_return_initial$PatEncCsnCoded.inp,]
nrow(dat_covid_inpatient_return)
dat_covid_inpatient_return<-merge(dat_covid_inpatient_return,dat_covid_return_initial[,c(1,3:5,9:10,6)],by=c("PatEncCsnCoded.inp" , "MRN"    ),all.x=T)
dat_covid_inpatient_return$return_pos_yn<-ifelse(is.na(dat_covid_inpatient_return$Return.Taken.Date)==F,1,0)
summary(dat_covid_inpatient_return$days_return_taken_adm)
summary(round(dat_covid_inpatient_return$days_take_adm))
##initial test 2-343 days before admission
###Only account for initial admissions
dat_covid_inpatient_return<-
dat_covid_inpatient_return %>%
arrange(MRN,Admission.Time,.by_group = TRUE) %>%
group_by(MRN) %>%
filter(row_number()==1)
dat_covid_inpatient_return<-data.frame(dat_covid_inpatient_return)
##nobody excluded had a return test
dat_covid_inpatient_directadm$Inpatient.Type<-"Direct Admitted"
dat_covid_inpatient_return$Inpatient.Type<-"Return to Hospital"
library(gtools)
dat_inpatient_final<-smartbind(dat_covid_inpatient_directadm,dat_covid_inpatient_return)
nrow(dat_inpatient_final)
length(unique(dat_inpatient_final$MRN))
colnames(dat_inpatient_final)
dat_inpatient_final<-dat_inpatient_final[is.na(dat_inpatient_final$MRN)==F,]
table(dat_inpatient_final$Inpatient.Type,useNA="ifany")
##171+55=226
nrow(dat_inpatient_final)
dat_inpatient_final$vcp<-ifelse(grepl("VCP",dat_inpatient_final$Dept.Name,fixed=T),1,0)
table(dat_inpatient_final$vcp)
###death
dat_inpatient_final<-merge(dat_inpatient_final,dat_covid_demo[,c("MRN","Date.of.Death")],by="MRN",all.x=T)
unique(dat_inpatient_final$Date.of.Death)
dat_inpatient_final$death<-ifelse(is.na(dat_inpatient_final$Date.of.Death)==F,1,0)
table(dat_inpatient_final$death)
colnames(dat_inpatient_final)
dat_covid_adt_icu<-dat_covid_adt[is.na(dat_covid_adt$Pat.Lvl.Care)==F & dat_covid_adt$Pat.Lvl.Care=="Critical Care" & (dat_covid_adt$PatEncCsnCoded %in% dat_inpatient_final$PatEncCsnCoded.inp.2|dat_covid_adt$PatEncCsnCoded %in% dat_inpatient_final$PatEncCsnCoded.inp.1|dat_covid_adt$PatEncCsnCoded %in% dat_inpatient_final$PatEncCsnCoded.inp ),]
dat_covid_adt$date<-as.Date(substring(dat_covid_adt$Event.Date,1,10),"%m/%d/%Y")
summary(dat_covid_adt$date)
dat_covid_adt_icu$date<-as.Date(substring(dat_covid_adt_icu$Event.Date,1,10),"%m/%d/%Y")
summary(dat_covid_adt_icu$date)
dat_inpatient_final$icu_adt<-ifelse(
dat_inpatient_final$PatEncCsnCoded.inp %in% dat_covid_adt_icu$PatEncCsnCoded|
dat_inpatient_final$PatEncCsnCoded.inp.1 %in% dat_covid_adt_icu$PatEncCsnCoded|
dat_inpatient_final$PatEncCsnCoded.inp.2 %in% dat_covid_adt_icu$PatEncCsnCoded
,1,0)
table(dat_inpatient_final$icu_adt)
table(dat_inpatient_final$icu_adt,dat_inpatient_final$death)
###By orders
dat_covid_orders_icu<-dat_covid_orders[(grepl("critical",tolower(dat_covid_orders$Description),fixed=T)|grepl("icu",tolower(dat_covid_orders$Description),fixed=T)) & dat_covid_orders$MRN %in% dat_inpatient_final$MRN,]
unique(dat_covid_orders_icu$Description)
dat_covid_orders_icu<-dat_covid_orders_icu[dat_covid_orders_icu$Description %in% c("CRITICAL CARE" ,"ICU Emergency Critical Care" ,"Weight- ICU Patients",  "Notify MD:Vital Signs (ICU)" ,"Volume Based Tube Feeding Protocol (ICU only)","Notify MD: Vital Signs (ICU)","Notify MD:Vital Signs(ICU)","ICU","Resp - CV-ICU Rapid Extubation Protocol (I-REP)"  ),]
colnames(dat_covid_orders_icu)
###9/29: csn id does not change to coded for order sets
dat_inpatient_final$icu_orders<-ifelse(
dat_inpatient_final$PatEncCsnCoded.inp %in% dat_covid_orders_icu$PatEncCsnId|
dat_inpatient_final$PatEncCsnCoded.inp.1 %in% dat_covid_orders_icu$PatEncCsnId|
dat_inpatient_final$PatEncCsnCoded.inp.2 %in% dat_covid_orders_icu$PatEncCsnId,1,0)
table(dat_inpatient_final$icu_orders)
###By procedures
##Intubation
dat_covid_intubation<-dat_covid_procedures[dat_covid_procedures$Description %in% c("Insertion of Endotracheal Airway into Trachea, Via Opening","Insertion of Endotracheal Airway into Trachea, Endo","INTUBATION ENDOTRACHEAL EMERGENCY PROCEDURE","TRACHEOSTOMY PLANNED SPX","Vent MGmt Inpat, Subq Day","Vent MGmt Inpat, Init Day" ,"VENTILATION ASSIST & MGMT INPATIENT EA SBSQ DAY","VENTILATION ASSIST & MGMT INPATIENT 1ST DAY") & is.na( dat_covid_procedures$PatEncCsnCoded)==F,]
dat_inpatient_final$intubation_yn<-ifelse(
dat_inpatient_final$PatEncCsnCoded.inp %in% dat_covid_intubation$PatEncCsnCoded|
dat_inpatient_final$PatEncCsnCoded.inp.1 %in% dat_covid_intubation$PatEncCsnCoded|
dat_inpatient_final$PatEncCsnCoded.inp.2 %in% dat_covid_intubation$PatEncCsnCoded
,1,0)
dat_covid_venilation<-dat_covid_procedures[dat_covid_procedures$Description %in% c("Respiratory Ventilation, Greater than 96 Consecutive Hours","Respiratory Ventilation, 24-96 Consecutive Hours","Assistance with Respiratory Ventilation, <24 Hrs, CPAP" ,"Respiratory Ventilation, Less than 24 Consecutive Hours","Ventilating tube removal requiring general anesthesia" )  & is.na( dat_covid_procedures$PatEncCsnCoded)==F,]
dat_inpatient_final$venilation_yn<-ifelse(
dat_inpatient_final$PatEncCsnCoded.inp %in% dat_covid_venilation$PatEncCsnCoded |
dat_inpatient_final$PatEncCsnCoded.inp.1 %in% dat_covid_venilation$PatEncCsnCoded |
dat_inpatient_final$PatEncCsnCoded.inp.2 %in% dat_covid_venilation$PatEncCsnCoded ,1,0)
##ECMO
dat_covid_ecmo<-dat_covid_procedures[dat_covid_procedures$Description %in% c("ECMO/ECLS" , "Extracorporeal Oxygenation, Perph VA ECMO"  )  & is.na( dat_covid_procedures$PatEncCsnCoded)==F,]
dat_inpatient_final$ecmo_yn<-ifelse(
dat_inpatient_final$PatEncCsnCoded.inp %in% dat_covid_ecmo$PatEncCsnCoded|
dat_inpatient_final$PatEncCsnCoded.inp.1 %in% dat_covid_ecmo$PatEncCsnCoded|
dat_inpatient_final$PatEncCsnCoded.inp.2 %in% dat_covid_ecmo$PatEncCsnCoded,1,0)
dat_inpatient_final$icu_procedures<-ifelse(dat_inpatient_final$intubation_yn==1|dat_inpatient_final$venilation_yn==1|dat_inpatient_final$ecmo_yn==1,1,0)
dat_inpatient_final$icu_final_yn<-ifelse(dat_inpatient_final$icu_procedures==1|dat_inpatient_final$icu_adt==1|dat_inpatient_final$icu_orders==1,1,0)
table(dat_inpatient_final$icu_final_yn)
##age group
#18-30, 31-50, 51-70, >71
dat_inpatient_final$Age_group<-ifelse(dat_inpatient_final$Age<=30,1,ifelse(dat_inpatient_final$Age<=50,2,ifelse(dat_inpatient_final$Age<=70,3,4)))
dat_inpatient_final$Age_group<-factor(dat_inpatient_final$Age_group,levels=1:4,labels=c("18-30","31-50","51-70",">=71"))
##Race-ethinicty
dat_inpatient_final<-merge(dat_inpatient_final,dat_covid_demo[,c("MRN","Race","Ethnicity")],by="MRN",all.x=T)
dat_inpatient_final$race_ethinicity<-ifelse(dat_inpatient_final$Ethnicity=="Hispanic/Latino","Hispanic/Latino",dat_inpatient_final$Race)
dat_inpatient_final$race_ethinicity[dat_inpatient_final$race_ethinicity=="Pacific Islander"]<-"Other"
dat_inpatient_final$race_ethinicity[dat_inpatient_final$race_ethinicity=="Native American"]<-"Other"
dat_inpatient_final$race_ethinicity[dat_inpatient_final$race_ethinicity=="Unknown"]<-NA
dat_inpatient_final$race_ethinicity[dat_inpatient_final$race_ethinicity==""]<-NA
table(dat_inpatient_final$race_ethinicity,useNA="ifany")
###########################################
###Add BMI data
dat_inpatient_final<-merge(dat_inpatient_final,dat_covid_demo[,c("MRN","Insurance.Name","Insurance.Type","Recent.Height.cm"  ,"Recent.Weight.kg", "Recent.BMI"    )],by="MRN",all.x=T)
summary(dat_inpatient_final$Recent.BMI)
summary(dat_inpatient_final$Recent.Weight.kg)
dat_inpatient_final$Recent.BMI[is.na(dat_inpatient_final$Recent.Weight.kg)|is.na(dat_inpatient_final$Recent.Height.cm)]<-NA
dat_inpatient_final$Recent.BMI.CAT<-cut(dat_inpatient_final$Recent.BMI,c(-Inf,25,30,35,40,Inf),right=F)
###Length of Stay
dat_inpatient_final$LOS<-as.numeric(difftime(dat_inpatient_final$Discharge.Time,dat_inpatient_final$Admission.Time,unit="days"))
summary( dat_inpatient_final$LOS)
###Add Gender
dat_inpatient_final<-merge(dat_inpatient_final,dat_covid_demo[,c("MRN","Gender")],by="MRN",all.x=T)
output_dir
output_path
dat_inpatient_old<-read.csv(file.path(output_path,"hospitalized_cohort_03092021.csv"),stringsAsFactors = F)
dat_inpatient_new<-read.csv(file.path(output_path,"hospitalized_cohort_0701_090721.csv"),stringsAsFactors = F)
colnames(dat_inpatient_old)
varlist<-c("MRN","Name" ,"Date","Age","Admission.Time","Discharge.Time","vcp" ,"Date.of.Death","death","intubation_yn","venilation_yn" ,"ecmo_yn","icu_final_yn","Age_group","Ethnicity"  ,"race_ethinicity"  , "Insurance.Name"   ,"Insurance.Type" ,"Recent.Height.cm" ,"Recent.Weight.kg"   ,"Recent.BMI","Recent.BMI.CAT"  , "LOS" ,"Gender"   )
dat_inpatient_combined<-rbind(dat_inpatient_final[,varlist],
dat_inpatient_old[,varlist],
dat_inpatient_new[,varlist])
nrow(dat_inpatient_combined)
length(unqique(dat_inpatient_combined$MRN))
length(unique(dat_inpatient_combined$MRN))
dat_inpatient_combined<-unique(dat_inpatient_combined)
nrow( dat_inpatient_combined)
View( dat_inpatient_combined[ dat_inpatient_combined$MRN %in%  dat_inpatient_combined$MRN[duplicated( dat_inpatient_combined$MRN)],])
a<-dat_inpatient_combined[ dat_inpatient_combined$MRN %in%  dat_inpatient_combined$MRN[duplicated( dat_inpatient_combined$MRN)],]
View(a[order(a$MRN),])
dat_inpatient_final$flag<-1
dat_inpatient_old$flag<-0
dat_inpatient_old$flag<-2
dat_inpatient_combined<-rbind(dat_inpatient_final[,varlist],
dat_inpatient_old[,varlist],
dat_inpatient_new[,varlist])
library(tidyverse)
dat_inpatient_combined<-dat_inpatient_combined %>%
group_by(MRN) %>%
mutate(flag_max=max(flag,na.rm=T)) %>%
filter(flag==flag_max)
varlist<-c("MRN","Name" ,"Date","Age","Admission.Time","Discharge.Time","vcp" ,"Date.of.Death","death","intubation_yn","venilation_yn" ,"ecmo_yn","icu_final_yn","Age_group","Ethnicity"  ,"race_ethinicity"  , "Insurance.Name"   ,"Insurance.Type" ,"Recent.Height.cm" ,"Recent.Weight.kg"   ,"Recent.BMI","Recent.BMI.CAT"  , "LOS" ,"Gender","flag"  )
dat_inpatient_combined<-rbind(dat_inpatient_final[,varlist],
dat_inpatient_old[,varlist],
dat_inpatient_new[,varlist])
library(tidyverse)
dat_inpatient_combined<-dat_inpatient_combined %>%
group_by(MRN) %>%
mutate(flag_max=max(flag,na.rm=T)) %>%
filter(flag==flag_max)
colnames(dat_inpatient_combined)
dat_inpatient_final$flag<-1
dat_inpatient_old$flag<-0
dat_inpatient_new$flag<-2
varlist<-c("MRN","Name" ,"Date","Age","Admission.Time","Discharge.Time","vcp" ,"Date.of.Death","death","intubation_yn","venilation_yn" ,"ecmo_yn","icu_final_yn","Age_group","Ethnicity"  ,"race_ethinicity"  , "Insurance.Name"   ,"Insurance.Type" ,"Recent.Height.cm" ,"Recent.Weight.kg"   ,"Recent.BMI","Recent.BMI.CAT"  , "LOS" ,"Gender","flag"  )
dat_inpatient_combined<-rbind(dat_inpatient_final[,varlist],
dat_inpatient_old[,varlist],
dat_inpatient_new[,varlist])
library(tidyverse)
dat_inpatient_combined<-dat_inpatient_combined %>%
group_by(MRN) %>%
mutate(flag_max=max(flag,na.rm=T)) %>%
filter(flag==flag_max)
nrow(dat_inpatient_combined)
length(unique(dat_inpatient_combined$MRN))
table(dat_inpatient_combined$flag)
a<-dat_inpatient_combined[ dat_inpatient_combined$MRN %in%  dat_inpatient_combined$MRN[duplicated( dat_inpatient_combined$MRN)],]
View(a[order(a$MRN),])
dat_inpatient_combined<-unique(dat_inpatient_combined)
nrow(dat_inpatient_combined)
a<-dat_inpatient_combined[ dat_inpatient_combined$MRN %in%  dat_inpatient_combined$MRN[duplicated( dat_inpatient_combined$MRN)],]
a
write.csv(dat_inpatient_combined,file.path(output_path,"hospitalized_cohort_030120to090721.csv"),row.names=F)
save.image("~/Working/Hospital_Medicine/Nidhi_Jason_COVID_Inpatient/Outputs/ICU_0913/RImage_091321_ICU.RData")
summary( dat_inpatient_new$Date)
unique( dat_inpatient_new$Date)
write.csv(dat_inpatient_combined,file.path(output_path,"hospitalized_cohort_030120to083121.csv"),row.names=F)
